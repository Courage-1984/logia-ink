const t="active",e="report-placeholder--hidden",r="report-placeholder--error";function a(){const e=Array.from(document.querySelectorAll("[data-report-tabs] .tab-button")),a=Array.from(document.querySelectorAll(".tab-content"));if(!e.length||!a.length)return;e.forEach((r,o)=>{r.setAttribute("tabindex",r.classList.contains(t)?"0":"-1"),r.addEventListener("click",()=>n(r,e,a,!1)),r.addEventListener("keydown",t=>function(t,e,r,a){const{key:o}=t;if(!["ArrowLeft","ArrowRight","Home","End"].includes(o))return;t.preventDefault();let s=e;"ArrowRight"===o?s=(e+1)%r.length:"ArrowLeft"===o?s=(e-1+r.length)%r.length:"Home"===o?s=0:"End"===o&&(s=r.length-1);const i=r[s];i&&n(i,r,a)}(t,o,e,a))}),a.forEach(e=>{e.classList.contains(t)||e.setAttribute("hidden","hidden"),function(t){const e=t.querySelector("[data-report-retry]");if(!e)return;e.addEventListener("click",()=>{const a=t.querySelector(".report-placeholder"),n=t.querySelector(".report-placeholder__hint");a?.classList.remove(r),n&&t.dataset.reportHint&&(n.textContent=`${t.dataset.reportHint} (retrying...)`),t.dataset.loaded="",e.setAttribute("hidden","hidden"),o(t)})}(e),function(t){const e=t.querySelector("[data-report-copy]"),r=t.querySelector(".report-json");if(!e||!r)return;e.addEventListener("click",async()=>{if(r.textContent)try{await navigator.clipboard.writeText(r.textContent),e.textContent="Copied!",e.classList.add("btn-primary"),setTimeout(()=>{e.textContent="Copy JSON",e.classList.remove("btn-primary")},1500)}catch(t){e.textContent="Copy failed",e.classList.add("btn-outline")}})}(e)});const s=a.find(e=>e.classList.contains(t));s&&o(s)}function n(e,r,a,n=!0){const s=e.dataset.tabTarget,i=document.getElementById(s);i&&(r.forEach(e=>{e.classList.remove(t),e.setAttribute("aria-selected","false"),e.setAttribute("tabindex","-1")}),a.forEach(e=>{e.classList.remove(t),e.setAttribute("hidden","hidden")}),e.classList.add(t),e.setAttribute("aria-selected","true"),e.setAttribute("tabindex","0"),n&&e.focus(),i.classList.add(t),i.removeAttribute("hidden"),o(i))}async function o(t){if(!t||"true"===t.dataset.loaded||"true"===t.dataset.loading)return;let a=t.dataset.reportSrc;const n=t.dataset.reportType||"iframe",o=t.querySelector(".report-placeholder"),s=t.querySelector(".report-placeholder__hint"),i=t.querySelector("[data-report-retry]"),d=t.querySelector(".report-frame"),c=t.querySelector(".report-json"),l=t.querySelector("[data-report-copy]");if(!a)return;["bundle-report.html","bundle-stats.json","stats.html"].some(t=>a.includes(t)),t.dataset.loading="true",o?.classList.remove(e,r),o?.setAttribute("aria-hidden","false");try{const u=await fetch(a,{cache:"no-store"});if(!u.ok)throw new Error(`HTTP ${u.status}`);const h=u.headers.get("content-type")||"";if("iframe"===n&&d){if(!h.includes("text/html")&&!h.includes("application/xhtml"))throw new Error(`Expected HTML but got ${h}`);const n=()=>{try{const a=d.contentDocument||d.contentWindow?.document;if(a){const n=a.title||"";d.contentWindow;if(n&&(n.includes("Operational Reports Dashboard")||n.includes("Logi-Ink")&&!n.includes(t.dataset.reportTitle||""))){if(t.dataset.loaded="false",o?.classList.remove(e),o?.classList.add(r),o?.setAttribute("aria-hidden","false"),d.hidden=!0,d.src="about:blank",s){const e=t.dataset.reportHint||"Report unavailable. Generate the artefact and try again.";s.textContent=`${e} (Report file not found - server returned fallback page)`}i?.removeAttribute("hidden")}}}catch(a){}};d.addEventListener("load",n,{once:!0}),d.src=a,d.hidden=!1}else if("json"===n&&c){if(!h.includes("application/json")&&!h.includes("text/json"))throw new Error(`Expected JSON but got ${h}`);const t=await u.json();c.textContent=JSON.stringify(t,null,2),c.hidden=!1,l&&(l.hidden=!1)}o?.classList.add(e),o?.setAttribute("aria-hidden","true"),t.dataset.loaded="true"}catch(u){if(d&&(d.src="about:blank",d.hidden=!0),o?.classList.remove(e),o?.classList.add(r),o?.setAttribute("aria-hidden","false"),s){const e=t.dataset.reportHint||"Report unavailable. Generate the artefact and try again.";s.textContent=`${e} (${u.message})`}i?.removeAttribute("hidden"),t.dataset.loaded="false"}finally{t.dataset.loading="false"}}export{a as initReportsPage};
