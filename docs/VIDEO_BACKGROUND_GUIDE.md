# Video Background Overlay Guide

This guide explains how to optimize and implement `ripples.mp4` as a background overlay that autoplays infinitely.

## üé• Video Optimization

### Prerequisites

**Install FFmpeg** (required for video optimization):

- **Windows**: Download from [https://www.gyan.dev/ffmpeg/builds/](https://www.gyan.dev/ffmpeg/builds/)
  - Extract and add to PATH, or place `ffmpeg.exe` in project root
- **macOS**: `brew install ffmpeg`
- **Linux**: `sudo apt-get install ffmpeg`

### Optimize the Video

Run the optimization script to create multiple optimized versions:

```bash
npm run optimize-video
```

This will create optimized versions in `assets/video/optimized/`:
- `ripples-hq.mp4` - High quality (1080p, 2 Mbps) for desktop
- `ripples-mq.mp4` - Medium quality (720p, 1.5 Mbps) for tablet
- `ripples-lq.mp4` - Low quality (480p, 800 kbps) for mobile
- `ripples-hq.webm` - WebM format (better compression, modern browsers)
- `ripples-poster.jpg` - Poster image (first frame) for faster initial load

### Optimization Settings Explained

The script optimizes videos for web background use with these considerations:

1. **Resolution**: Multiple sizes for responsive loading
   - Desktop: 1920x1080 (1080p)
   - Tablet: 1280x720 (720p)
   - Mobile: 854x480 (480p)

2. **Bitrate**: Lower bitrates for smaller file sizes
   - Desktop: 2 Mbps
   - Tablet: 1.5 Mbps
   - Mobile: 800 kbps

3. **Frame Rate**: 30 fps (desktop/tablet), 24 fps (mobile)
   - Background videos don't need 60 fps

4. **Codec**: H.264 (MP4) for compatibility, VP9 (WebM) for better compression

5. **Audio**: Removed (saves significant file size for background videos)

6. **Fast Start**: MP4 files are optimized for web streaming

## üé¨ Implementation

### Lazy-Load Module Overview

Background videos are now injected at runtime by `js/utils/ripples-lazyload.js`. Instead of shipping all `<video>` sources in the HTML, we render an empty container and let the module decide which asset variant (WebM, HQ/MQ/LQ MP4) is best based on viewport width and the user's connection quality.

The module:

- Waits until `#background-video-container` is about to enter the viewport (IntersectionObserver)
- Detects low-bandwidth connections via the Network Information API
- Prefers VP9 WebM sources on capable browsers, otherwise falls back to MP4 tiers
- Injects the `<video>` element with autoplay/muted/loop attributes and fades it in once ready

### HTML Structure

Place the container inside the section that needs the animated backdrop (the Technologies/services preview on the homepage uses this pattern):

```html
<section class="services-preview">
  <div class="section-video-background" role="presentation" aria-hidden="true">
    <div
      id="background-video-container"
      class="background-video-container"
      data-video="ripples"
      data-poster="ripples-poster.jpg"
      data-path="assets/video/optimized"
    ></div>
  </div>
  <div class="section-video-overlay"></div>

  <div class="container">
    <!-- Section content -->
  </div>
</section>
```

`initBackgroundVideoLazyLoad()` looks specifically for an element with the `background-video-container` id. If you need more than one lazy-loaded background, duplicate the module or update it to query by class (documented near the top of the file).

### Data Attributes

- `data-video`: Base filename used to assemble `*-hq.mp4`, `*-mq.mp4`, `*-lq.mp4`, `*-webm.webm`, and the `*-poster.jpg`.
- `data-poster`: Poster filename (defaults to `<base>-poster.jpg` when omitted).
- `data-path`: Relative directory where the optimised derivatives live (defaults to `assets/video/optimized`).

Leaving the defaults is fine if you follow the naming scheme generated by `npm run optimize-video`.

### What Gets Injected

At runtime the module appends:

```html
<video
  class="background-video is-ready"
  autoplay
  muted
  loop
  playsinline
  poster="assets/video/optimized/ripples-poster.jpg"
  data-src="assets/video/optimized/ripples-webm.webm"
  aria-hidden="true"
  tabindex="-1"
></video>
```

Once playback starts, the element receives `is-ready` so CSS can fade it in.

## üé® CSS Styling

Video styling lives in `css/components/cards.css` alongside the services preview cards:

```css
.section-video-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  overflow: hidden;
  background: rgba(10, 10, 10, 0.8)
    url('../../assets/video/optimized/ripples-poster.jpg') center/cover no-repeat;
}

.background-video-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.section-video-background video {
  position: absolute;
  top: 50%;
  left: 50%;
  min-width: 100%;
  min-height: 100%;
  transform: translate(-50%, -50%);
  object-fit: cover;
  object-position: center;
  opacity: 0;
  transition: opacity 600ms ease;
}

.section-video-background video.is-ready {
  opacity: 1;
}

.section-video-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    135deg,
    rgba(10, 10, 10, 0.7) 0%,
    rgba(26, 26, 46, 0.6) 50%,
    rgba(22, 33, 62, 0.7) 100%
  );
  z-index: 1;
  pointer-events: none;
}

.services-preview .container {
  position: relative;
  z-index: 2;
}
```

## ‚ö° Performance Best Practices

### 1. File Size Optimization

- **Keep video short**: 3-10 seconds is ideal for looping backgrounds
- **Lower bitrate**: 1-2 Mbps is sufficient for background videos
- **Lower resolution**: 1080p max, often 720p is enough
- **Remove audio**: Saves significant file size

### 2. Loading Strategy

- **IntersectionObserver**: The module waits until the section is nearly visible before loading video
- **Poster image**: `ripples-poster.jpg` is applied as a background and as the `<video>` poster
- **Connection awareness**: Low-bandwidth users receive the lightweight MP4 automatically

### 3. Mobile Considerations

- **Lower quality on mobile**: Automatically served via the `*-lq.mp4` fallback
- **Provide static backup**: `.section-video-background` already paints the poster as a background
- **Test on real devices**: Confirm the lazy-load handoff feels smooth on mid-range hardware

### 4. Browser Compatibility

- **MP4 (H.264)**: Universal support (IE9+)
- **WebM (VP9)**: Modern browsers (Chrome, Firefox, Edge)
- **Fallback**: Always include MP4 as fallback

## üîß Customisation Tips

- **Swap the loop**: Replace `data-video` with the new base filename (e.g. `nebula` to use `nebula-hq.mp4`, `nebula-webm.webm`, etc.).
- **Different poster**: Override `data-poster` if the auto-generated name does not match your asset.
- **Alternative directories**: Point `data-path` to custom folders when storing campaign-specific loops elsewhere.
- **Disable on mobile**: Add CSS to hide `.section-video-background video` below a breakpoint; the poster/background still renders thanks to the container background.
- **Multiple sections**: Clone `initBackgroundVideoLazyLoad` or generalise it to query multiple nodes if you need more than one lazy-loaded video on a page.

## üéØ Accessibility

- **`aria-label`**: Describes video for screen readers
- **Poster image**: Provides visual fallback
- **No audio**: Background videos should be silent
- **Keyboard navigation**: Ensure video doesn't interfere with keyboard users

## üêõ Troubleshooting

### Video not autoplaying

- Ensure `muted` attribute is present (required by browsers)
- Check browser autoplay policies
- Verify video file paths are correct

### Video not looping

- Ensure `loop` attribute is present
- Check browser compatibility

### Video too large/slow loading

- Re-run optimization script with lower bitrates
- Use lower resolution versions
- Consider disabling on mobile

### Video not covering entire area

- Check `object-fit: cover` is applied
- Verify video dimensions are correct
- Ensure container has `overflow: hidden`

## üìä File Size Guidelines

Target file sizes for background videos:

- **Desktop (1080p)**: 2-5 MB for 10-second loop
- **Tablet (720p)**: 1-3 MB for 10-second loop
- **Mobile (480p)**: 500 KB - 1.5 MB for 10-second loop

If files are larger, reduce:
- Bitrate (lower `-crf` value or lower bitrate)
- Resolution
- Frame rate
- Video duration

## üöÄ Next Steps

1. **Optimize video**: Run `npm run optimize-video`
2. **Add to HTML**: Insert the lazy-load container markup (or update attributes if it already exists)
3. **Verify lazy-load**: Scroll the section into view locally and confirm the `is-ready` transition
4. **Monitor performance**: Track network activity and Web Vitals to ensure the loop isn't blocking interaction
5. **Adjust as needed**: Fine-tune bitrates/resolutions based on results or adjust the module for edge cases

## üìö Additional Resources

- [FFmpeg Documentation](https://ffmpeg.org/documentation.html)
- [MDN: Video Element](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video)
- [Web Video Codec Guide](https://developer.mozilla.org/en-US/docs/Web/Media/Formats/Video_codecs)
- [Autoplay Policy](https://developer.mozilla.org/en-US/docs/Web/Media/Autoplay_guide)

